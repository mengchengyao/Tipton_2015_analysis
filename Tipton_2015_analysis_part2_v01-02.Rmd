---
title: "Tipton_2015_analysis_part2_v01-01"
author: "William Guesdon"
date: "22/01/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, message=FALSE}
################
# Load libraries
################

library(tidyverse)
library(alakazam)
library(shazam)
library(cowplot)
library(rstatix)
library(cowplot)
library(ggpubr)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
#####################
#Set up ggplot theme
####################

tmp_theme <- theme_bw()

##########################################
#Set up color blind friendly color palette
##########################################

# The palette with grey:
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# The palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# To use for fills, add
  # scale_fill_manual(values=cbPalette)
# To use for line and point colors, add
  # scale_colour_manual(values=cbPalette)
```

# Load Changeo processed table
```{r}
directory <- "/Users/william/Documents/GitHub/GitHub_Data/Tipton_2015_SLE_vs_HC/Immcantation/all_samples/"
file <- dir(directory, pattern = "*.tab")
```

```{r}
all_samples <- readChangeoDb(paste0(directory, file[1]))
```

```{r}
#glimpse(all_samples)
```
# Plot sequecens for each isotype
```{r}
db <- all_samples
```

Add isotypes
See sequences in the papers

```{r}
# db <- db  %>%
#   mutate(ISOTYPE = 
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GGGAGTGCATCCGCCCC', ignore_case=TRUE)), "IgM",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCACCCACCAAGGCTCC', ignore_case=TRUE)), "IgD",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCATCCCCGACCAGCCC', ignore_case=TRUE)), "IgA",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCCTCCACCAAGGGCCC', ignore_case=TRUE)), "IgG",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCTTCCACCAAGGGCCC', ignore_case=TRUE)), "IgG",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCCTCCACACAGAGCCC', ignore_case=TRUE)), "IgE", NA
#            ))))))
#          )
```

```{r}
# db <- db  %>%
#   mutate(ISOTYPE =
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('CCTTTTCCCCCTCGTCTCCTG', ignore_case=TRUE)), "IgM",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCACCCACCAAGGCTCC', ignore_case=TRUE)), "IgD",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('CGACCAGCCCCAAGGTCTTC', ignore_case=TRUE)), "IgA",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('TCCACCAAGGGCCCATCGG', ignore_case=TRUE)), "IgG",
#            ifelse(str_detect(SEQUENCE_INPUT, fixed('GCCTCCACACAGAGCCC', ignore_case=TRUE)), "IgE", NA
#            )))))
#          )
```

Issue with determining the isotype. Try to reduce the signature in case the problem is linked to shorted read.
The issue is that some isotype could be not be correctly identified.
```{r}
db <- db  %>%
  mutate(ISOTYPE =
           ifelse(str_detect(SEQUENCE_INPUT, fixed('GGGAGT', ignore_case=TRUE)), "IgM",
           ifelse(str_detect(SEQUENCE_INPUT, fixed('GCACCC', ignore_case=TRUE)), "IgD",
           ifelse(str_detect(SEQUENCE_INPUT, fixed('GCATCC', ignore_case=TRUE)), "IgA",
           ifelse(str_detect(SEQUENCE_INPUT, fixed('GCCTCC', ignore_case=TRUE)), "IgG",
           ifelse(str_detect(SEQUENCE_INPUT, fixed('GCTTCC', ignore_case=TRUE)), "IgG",
           ifelse(str_detect(SEQUENCE_INPUT, fixed('GCCTCC', ignore_case=TRUE)), "IgE", NA
           ))))))
         )
```

```{r}
nrow(db)
```

```{r}
db <- db  %>%
    filter(!is.na(ISOTYPE)) %>%
    filter(!is.na(D_CALL))
nrow(db)
#View(db)
```

# Compare HC vs SLE IgM sequences
```{r}
db %>% 
    group_by(STATUS, ISOTYPE) %>%
    count() %>%
    knitr::kable()
```

```{r message=FALSE}
directory <- "/Users/william/Documents/GitHub/Tipton_2015_analysis/Output/"
title <- 'Isotype_count_per_health_status'
file <- paste0(directory,title,'.png')

bar <- ggplot(db)+
        aes(x = STATUS, fill = ISOTYPE) +
        geom_bar(position = PositionDodge, color='black') +
        theme_bw() +
        scale_fill_manual(name="Isotype", values=cbPalette)+
        ggtitle(title)

plot(bar)
ggsave(bar, filename = file)
```

# Mutation analysis
```{r}
#see 10X_Got_IGH_analysis_v01-02
# Collapse clone for analysis
db <- collapseClones(db, cloneColumn = "CLONE",
                      sequenceColumn = "SEQUENCE_IMGT",
                      germlineColumn = "GERMLINE_IMGT_D_MASK", muFreqColumn = NULL,
                      regionDefinition = NULL, method = c("mostCommon", "thresholdedFreq",
                                                          "catchAll", "mostMutated", "leastMutated"), minimumFrequency = NULL,
                      includeAmbiguous = FALSE, breakTiesStochastic = FALSE,
                      breakTiesByColumns = NULL, expandedDb = FALSE, nproc = 1)

# Calculate combined R and S mutation frequencies
db_obs <- observedMutations(db, sequenceColumn="SEQUENCE_IMGT",
                            germlineColumn="GERMLINE_IMGT_D_MASK",
                            regionDefinition=NULL,
                            frequency=TRUE, 
                            combine=TRUE,
                            nproc=1)
```

```{r message=FALSE}
# Plot mutation frequencies per subsets and isotypes
title <- "Mutation frequency by subsets and isotypes"
file <- paste0('Output/',title,'.png')

boxplot <- ggplot(db_obs, aes(x=STATUS, y=MU_FREQ, fill=ISOTYPE)) +
  theme_bw() +
  ggtitle(title)+
  xlab("Subsets") + ylab("Mutation frequency") +
  scale_fill_manual(name="Isotype", values=cbPalette) +
  geom_boxplot(notch = TRUE, varwidth = FALSE)

plot(boxplot)
ggsave(boxplot, filename = file)

stat <- aov(MU_FREQ ~ STATUS, data = db_obs)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "MU_FREQ") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/MU_FREQ_stat.csv")
#knitr::kable(stat) 
```

# Physico-chemical properties analysis
```{r}
db_props <- aminoAcidProperties(db_obs, seq="JUNCTION", nt=TRUE, trim=TRUE, 
                                label="CDR3")
db_props_copy <- db_props
```

```{r}
db_props_summary <- db_props %>%
    group_by(STATUS, ISOTYPE) %>%
    select(
        STATUS,
        ISOTYPE,
        CDR3_AA_LENGTH,
        CDR3_AA_GRAVY,
        CDR3_AA_BASIC,
        CDR3_AA_ACIDIC,
        CDR3_AA_AROMATIC,
        CDR3_AA_ALIPHATIC,
        CDR3_AA_POLARITY
    )
write_csv(db_props_summary, "Output/db_props_summary.csv")
#View(db_props_summary)
```

```{r message=FALSE, warning=FALSE}
# Generate plots for a four of the properties
# https://alakazam.readthedocs.io/en/stable/vignettes/AminoAcids-Vignette/
# https://github.com/kassambara/ggpubr/issues/102
# https://stackoverflow.com/questions/19876505/boxplot-show-the-value-of-mean

# Filter IgM sequences
db_props <- db_props_copy %>% filter(ISOTYPE == "IgM")

# CDR3_AA_LENGTH
g1 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_LENGTH)) + tmp_theme +
        ggtitle("total amino acid count") + 
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point", shape=18, size=3,show_guide = FALSE)

# CDR3_AA_GRAVY
g2 <-  ggplot(db_props, aes(x=STATUS, y=CDR3_AA_GRAVY)) + tmp_theme + 
        ggtitle("grand average of hydrophobicity") + 
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

# CDR3_AA_BASIC
g3 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_BASIC)) + tmp_theme +
        ggtitle("basic side chain residue content") + 
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

# CDR3_AA_ACIDIC
g4 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_ACIDIC)) + tmp_theme +
        ggtitle("acidic side chain content") + 
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

# CDR3_AA_AROMATIC
g5 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_AROMATIC)) + tmp_theme +
        ggtitle("aromatic side chain content")+
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

# CDR3_AA_ALIPHATIC
g6 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_ALIPHATIC)) + tmp_theme +
        ggtitle("normalized aliphatic index")+
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

# CDR3_AA_POLARITY        
g7 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_POLARITY)) + tmp_theme +
        ggtitle("average polarity")+
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

# CDR3_AA_CHARGE        
g8 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_CHARGE)) + tmp_theme +
        ggtitle("normalized net charge")+
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)
 
# CDR3_AA_BULK       
g9 <-ggplot(db_props, aes(x=STATUS, y=CDR3_AA_BULK)) + tmp_theme +
        ggtitle("average bulkiness")+
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point",shape=18, size=2,show_guide = FALSE)

plot(g1)
stat <- aov(CDR3_AA_LENGTH ~ STATUS, data = db_props) %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_LENGTH") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
  write_csv(stat, "Output/IgM/CDR3_AA_LENGTH_stat.csv")
  knitr::kable(stat) 

plot(g2)
stat <- aov(CDR3_AA_GRAVY ~ STATUS, data = db_props) %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_GRAVY") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
 write_csv(stat, "Output/IgM/CDR3_AA_GRAVY_stat.csv")
 knitr::kable(stat)

plot(g3)
stat <- aov(CDR3_AA_BASIC ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_BASIC") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_BASIC_stat.csv")
knitr::kable(stat)

plot(g4)
stat <- aov(CDR3_AA_ACIDIC ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_ACIDIC") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_ACIDIC_stat.csv")
knitr::kable(stat)

plot(g5)
stat <- aov(CDR3_AA_AROMATIC ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_AROMATIC") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_AROMATIC_stat.csv")
knitr::kable(stat)

plot(g6)
stat <- aov(CDR3_AA_ALIPHATIC ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_ALIPHATIC") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_ALIPHATIC_stat.csv")
knitr::kable(stat)

plot(g7)
stat <- aov(CDR3_AA_POLARITY ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_POLARITY") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_POLARITY_stat.csv")
knitr::kable(stat)

plot(g8)
stat <- aov(CDR3_AA_CHARGE ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_CHARGE") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_CHARGE_stat.csv")
knitr::kable(stat)

plot(g9)
stat <- aov(CDR3_AA_BULK ~ STATUS, data = db_props)  %>% 
    tukey_hsd() %>% 
    mutate(variable = "CDR3_AA_BULK") %>% 
    select(variable, group1, group2, p.adj, p.adj.signif) %>% 
    arrange(p.adj)
write_csv(stat, "Output/IgM/CDR3_AA_BULK_stat.csv")
knitr::kable(stat)

ggsave(g1, filename = "Output/IgM/total_amino_acid_count.png")
ggsave(g2, filename = "Output/IgM/grand_average_of_hydrophobicity.png")
ggsave(g3, filename = "Output/IgM/basic_side_chain_residue_content.png")
ggsave(g4, filename = "Output/IgM/acidic_side_chain_content.png")
ggsave(g5, filename = "Output/IgM/aromatic_side_chain_content.png")
ggsave(g6, filename = "Output/IgM/normalized aliphatic index.png")
ggsave(g7, filename = "Output/IgM/average_polarity.png")
ggsave(g8, filename = "Output/IgM/normalized_net_charge.png")
ggsave(g9, filename = "Output/IgM/average_bulkiness.png")
```

```{r warnings = FALSE, mesage=FALSE}
db_props <- db_props_copy

g1 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_LENGTH)) + tmp_theme +
        ggtitle("total amino acid count") + 
        xlab("STATUSs") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        geom_boxplot(aes(fill=STATUS), notch = TRUE, varwidth = FALSE)+
        stat_summary(fun.y=mean, colour="black", geom="point", shape=18, size=3,show_guide = FALSE)+
        facet_wrap( .~ ISOTYPE)

ggsave(g1, filename = "Output/total_amino_acid_count.png")

plot(g1)
```

```{r}
g1 <- ggplot(db_props, aes(x=STATUS, y=CDR3_AA_LENGTH, fill = STATUS)) + 
    tmp_theme +
        ggtitle("total amino acid count") + 
        xlab("STATUS") +
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        stat_summary(geom = "bar", fun.y = mean, position = "dodge", color = "Black") +
        facet_wrap( .~ ISOTYPE)

ggsave(g1, filename = "Output/total_amino_acid_count.png")

plot(g1)
```

```{r}
#See Bar_and_errors_graph.Rmd
```

```{r message=FALSE}
g1 <- db_props  %>%
  group_by(STATUS, ISOTYPE) %>%
  summarise(
    mean = mean(MU_FREQ),
    se = sd(MU_FREQ)/sqrt(n())) %>%
    ggplot( aes(x=STATUS, y=mean, fill = STATUS))+
    geom_bar(stat="identity",
           colour="black",
           position=position_dodge(0.9)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
                position=position_dodge(0.9), width = 0.2)+
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        theme(text = element_text(size=20))+
        ylab("MU_FREQ")+
        tmp_theme +
        facet_wrap( .~ ISOTYPE)

ggsave(g1, filename = "Output/MU_FREQ.png")
plot(g1)
```

```{r message=FALSE}
g1 <- db_props  %>%
  group_by(STATUS, ISOTYPE) %>%
  summarise(
    mean = mean(CDR3_AA_LENGTH),
    se = sd(CDR3_AA_LENGTH)/sqrt(n())) %>%
    ggplot( aes(x=STATUS, y=mean, fill = STATUS))+
    geom_bar(stat="identity",
           colour="black",
           position=position_dodge(0.9)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
                position=position_dodge(0.9), width = 0.2)+
        scale_fill_manual(name="STATUSs", values=cbPalette, guide=FALSE) +
        theme(text = element_text(size=20))+
        ylab("CDR3_AA_LENGTH")+
        tmp_theme +
        facet_wrap( .~ ISOTYPE)

ggsave(g1, filename = "Output/total_amino_acid_count.png")
plot(g1)

g2 <- db_props  %>%
  group_by(STATUS, ISOTYPE) %>%
  summarise(
    mean = mean(CDR3_AA_GRAVY),
    se = sd(CDR3_AA_GRAVY)/sqrt(n())) %>%
    ggplot( aes(x=STATUS, y=mean, fill = STATUS))+
    geom_bar(stat="identity",
           colour="black",
           position=position_dodge(0.9)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
                position=position_dodge(0.9), width = 0.2)+
        scale_fill_manual(name="STATUS", values=cbPalette, guide=FALSE) +
        theme(text = element_text(size=20))+
        ylab("CDR3_AA_GRAVY")+
        tmp_theme +
        facet_wrap( .~ ISOTYPE)

ggsave(g2, filename = "Output/CDR3_AA_GRAVY.png")
plot(g2)

g3 <- db_props  %>%
  group_by(STATUS, ISOTYPE) %>%
  summarise(
    mean = mean(CDR3_AA_BASIC),
    se = sd(CDR3_AA_BASIC)/sqrt(n())) %>%
    ggplot( aes(x=STATUS, y=mean, fill = STATUS))+
    geom_bar(stat="identity",
           colour="black",
           position=position_dodge(0.9)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
                position=position_dodge(0.9), width = 0.2)+
        scale_fill_manual(name="STATUS", values=cbPalette, guide=FALSE) +
        theme(text = element_text(size=20))+
        ylab("CDR3_AA_BASIC")+
        tmp_theme +
        facet_wrap( .~ ISOTYPE)
ggsave(g3, filename = "Output/CDR3_AA_BASIC.png")
plot(g3)


```

```{r message=FALSE}
#https://stackoverflow.com/questions/29678435/how-to-pass-dynamic-column-names-in-dplyr-into-custom-function
# https://stackoverflow.com/questions/29678435/how-to-pass-dynamic-column-names-in-dplyr-into-custom-function
# https://stackoverflow.com/questions/38511743/adding-missing-grouping-variables-message-in-dplyr-in-r

#View(db_props)

selected_variables <- c("MU_FREQ", "CDR3_AA_LENGTH", "CDR3_AA_GRAVY", "CDR3_AA_BASIC", "CDR3_AA_ACIDIC", "CDR3_AA_AROMATIC", "CDR3_AA_ALIPHATIC", "CDR3_AA_POLARITY")

for (i in selected_variables){
#print(i)
g1 <- db_props  %>%
    select(STATUS, ISOTYPE, !!as.name(i)) %>%
    group_by(!!as.name(STATUS), !!as.name(ISOTYPE)) %>%
    summarise(
    mean = mean(!!as.name(i)),
    se = sd(!!as.name(i))/sqrt(n())) %>%
    ggplot( aes(x=STATUS, y=mean, fill = STATUS))+
    geom_bar(stat="identity",
           colour="black",
           position=position_dodge(0.9)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
                position=position_dodge(0.9), width = 0.2)+
        scale_fill_manual(name="STATUS", values=cbPalette, guide=FALSE) +
        theme(text = element_text(size=20))+
        ylab(i)+
        tmp_theme +
        facet_wrap( .~ ISOTYPE)

ggsave(g1, filename = paste0("Output/", i, ".png"))
#plot(g1)
}
    
#View(test)
```
